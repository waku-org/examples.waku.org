(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[240],{7420:function(){},5856:function(){},6601:function(){},2678:function(){},5819:function(){},4112:function(){},1265:function(){},5539:function(){},4280:function(e,t,r){Promise.resolve().then(r.bind(r,3663))},3663:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Home}});var n,s,i,a,o,l,c,d,u,h=r(7437);(o||(o={})).FlexHorizontal="flex-horizontal";let Block=e=>{let t="flex-horizontal"===e.type?"items-center justify-between lg:flex":"",r=e.className||"";return(0,h.jsx)("div",{className:"".concat(t," ").concat(r),children:e.children})},Title=e=>(0,h.jsx)("h1",{className:"text-4xl ".concat(e.className||""),children:e.children}),Status=e=>(0,h.jsxs)("p",{className:"text-s",children:[e.text,":"," ",(0,h.jsx)("span",{className:"underline underline-offset-3 decoration-4 decoration-blue-400 dark:decoration-blue-600",children:e.mark})]});var m=r(4660);let g="none",y=(0,m.Ue)(e=>({appStatus:g,setAppStatus:t=>e(e=>({...e,appStatus:t})),ethAccount:"",setEthAccount:t=>e(e=>({...e,ethAccount:t})),chainID:void 0,setChainID:t=>e(e=>({...e,chainID:t})),lastMembershipID:void 0,setLastMembershipID:t=>e(e=>({...e,lastMembershipID:t})),credentials:void 0,setCredentials:t=>e(e=>({...e,credentials:t})),wakuStatus:g,setWakuStatus:t=>e(e=>({...e,wakuStatus:t})),activeCredential:g,setActiveCredential:t=>e(e=>({...e,activeCredential:t})),keystoreCredentials:[],setKeystoreCredentials:t=>e(e=>({...e,keystoreCredentials:t})),activeMembershipID:void 0,setActiveMembershipID:t=>e(e=>({...e,activeMembershipID:t}))}));var x=r(2265),k=r(379),f=r(3981);let isBrowserProviderValid=e=>!!e&&"function"==typeof e.request,isEthereumEvenEmitterValid=e=>!!e&&"function"==typeof e.on&&"function"==typeof e.removeListener;var p=r(3215),v=r.n(p);let b=new(v()).Type("ChatMessage").add(new(v()).Field("timestamp",1,"uint64")).add(new(v()).Field("nick",2,"string")).add(new(v()).Field("text",3,"string"));(n=l||(l={})).WASM_LOADING="WASM Blob download in progress...",n.WASM_FAILED="Failed to download WASM, check console",n.CONTRACT_LOADING="Connecting to RLN contract",n.CONTRACT_FAILED="Failed to connect to RLN contract",n.RLN_INITIALIZED="RLN dependencies initialized",n.KEYSTORE_LOCAL="Keystore initialized from localStore",n.KEYSTORE_NEW="New Keystore was initialized",n.CREDENTIALS_REGISTERING="Registering credentials...",n.CREDENTIALS_REGISTERED="Registered credentials",n.CREDENTIALS_FAILURE="Failed to register credentials, check console",(s=c||(c={})).Status="status",s.Keystore="keystore-changed";let N=new class{async init(){if(this.initialized||this.initializing)return;this.initializing=!0;let e=await this.initRLNWasm();await this.initRLNContract(e),this.emitStatusEvent(l.RLN_INITIALIZED),this.emitKeystoreKeys(),this.initialized=!0,this.initializing=!1}async initRLNWasm(){this.emitStatusEvent(l.WASM_LOADING);try{return this.rlnInstance=await (0,f.Ue)(),this.rlnInstance}catch(e){throw console.error("Failed at fetching WASM and creating RLN instance: ",e),this.emitStatusEvent(l.WASM_FAILED),e}}async initRLNContract(e){this.emitStatusEvent(l.CONTRACT_LOADING);try{this.rlnContract=await f.X.init(e,{registryAddress:f.d$.address,provider:this.ethProvider.getSigner()})}catch(e){throw console.error("Failed to connect to RLN contract: ",e),this.emitStatusEvent(l.CONTRACT_FAILED),e}}initKeystore(){let e=localStorage.getItem("keystore"),t=f.YK.fromString(e||"");return t||f.YK.create()}addEventListener(e,t){return this.emitter.addEventListener(e,t)}removeEventListener(e,t){return this.emitter.removeEventListener(e,t)}emitStatusEvent(e){this.emitter.dispatchEvent(new CustomEvent("status",{detail:e}))}emitKeystoreKeys(){let e=Object.keys(this.keystore.toObject().credentials||{});this.emitter.dispatchEvent(new CustomEvent("keystore-changed",{detail:e}))}async saveKeystore(){localStorage.setItem("keystore",this.keystore.toString()),this.emitKeystoreKeys()}importKeystore(e){this.keystore=f.YK.fromString(e)||f.YK.create(),this.saveKeystore()}constructor(){this.emitter=new EventTarget,this.initialized=!1,this.initializing=!1;let e=window.ethereum;if(!isBrowserProviderValid(e))throw Error("Invalid Ethereum provider present on the page. Check if MetaMask is connected.");this.ethProvider=new k.Q(e,"any"),this.keystore=this.initKeystore()}},useRLN=()=>{let{setAppStatus:e,setKeystoreCredentials:t}=y(),r=x.useRef(void 0);return x.useEffect(()=>{if(r.current||!N)return;let n=!1,statusListener=t=>{e(null==t?void 0:t.detail)};N.addEventListener(c.Status,statusListener);let keystoreListener=e=>{t((null==e?void 0:e.detail)||[])};N.addEventListener(c.Keystore,keystoreListener);let run=async()=>{n||(await (null==N?void 0:N.init()),r.current=N)};return run(),()=>{n=!0,null==N||N.removeEventListener(c.Status,statusListener),null==N||N.removeEventListener(c.Keystore,keystoreListener)}},[r,e]),{rln:r.current}},useWallet=()=>{let{rln:e}=useRLN(),{setEthAccount:t,setChainID:r,setCredentials:n}=y();x.useEffect(()=>{let e=window.ethereum;if(!isEthereumEvenEmitterValid(e)){console.log("Cannot subscribe to ethereum events.");return}let onAccountsChanged=e=>{t(e[0]||"")};e.on("accountsChanged",onAccountsChanged);let onChainChanged=e=>{let t=parseInt(e,16);r(t)};return e.on("chainChanged",onChainChanged),()=>{e.removeListener("chainChanged",onChainChanged),e.removeListener("accountsChanged",onAccountsChanged)}},[t,r]);let s=x.useCallback(async()=>{var t;if(!(null==e?void 0:e.ethProvider)){console.log("Cannot generate credentials, no provider found.");return}let r=e.ethProvider.getSigner(),s=await r.signMessage("".concat("The signature of this message will be used to generate your RLN credentials. Anyone accessing it may send messages on your behalf, please only share with the RLN dApp",". Nonce: ").concat(Math.ceil(1e3*Math.random()))),i=await (null===(t=e.rlnInstance)||void 0===t?void 0:t.generateSeededIdentityCredential(s));n(i)},[e,n]);return{onGenerateCredentials:s}},useContract=()=>{let{rln:e}=useRLN(),{setEthAccount:t,setChainID:r,setLastMembershipID:n}=y(),s=x.useCallback(async()=>{let s=new Promise(async n=>{if(!e){console.log("Cannot fetch wallet, not provider found."),n();return}try{let n=await e.ethProvider.send("eth_requestAccounts",[]);t(n[0]||"");let s=await e.ethProvider.getNetwork();r(s.chainId)}catch(e){console.error("Failed to connect to account: ",e)}n()}),i=new Promise(async t=>{if(!(null==e?void 0:e.rlnContract)||!(null==e?void 0:e.rlnInstance)){console.log("Cannot fetch contract info, no contract found."),t();return}try{await e.rlnContract.fetchMembers(e.rlnInstance),e.rlnContract.subscribeToMembers(e.rlnInstance);let t=e.rlnContract.members.at(-1);t&&n(t.index.toNumber())}catch(e){console.error("Failed to fetch contract state: ",e)}t()});await Promise.any([s,i])},[e,t,r,n]);return{onFetchContract:s}};var C=r(2355);(i=d||(d={})).Status="status",i.Message="message",(a=u||(u={})).INITIALIZING="Initializing",a.WAITING_FOR_PEERS="Waiting for peers",a.STARTING="Starting the node",a.READY="Ready";let E=new class{async init(e){this.initialized||this.initializing||!e.rln.rlnInstance||(this.initializing=!0,this.initEncoder(e),this.decoder=new f.pU(e.rln.rlnInstance,(0,C.UF)(this.contentTopic)),!this.node&&(this.emitStatusEvent("Initializing"),this.node=await (0,C.pq)({defaultBootstrap:!0}),this.emitStatusEvent("Starting the node"),await this.node.start(),this.emitStatusEvent("Waiting for peers"),await (0,C.gT)(this.node),this.emitStatusEvent("Ready"),e.rln.rlnContract&&await this.subscribeToMessages({node:this.node,decoder:this.decoder,rlnContract:e.rln.rlnContract})),this.initialized=!0,this.initializing=!1)}initEncoder(e){let{rln:t,membershipID:r,credentials:n}=e;t.rlnInstance&&(this.encoder=new f.vg((0,C.Mf)({ephemeral:!1,contentTopic:this.contentTopic}),t.rlnInstance,r,n))}async sendMessage(e,t){if(!this.node||!this.encoder)return;let r=new Date,n=b.create({text:t,nick:e,timestamp:Math.floor(r.valueOf()/1e3)}),s=b.encode(n).finish();console.log("Sending message with proof..."),await this.node.lightPush.send(this.encoder,{payload:s,timestamp:r}),console.log("Message sent!")}async subscribeToMessages(e){await e.node.filter.subscribe(e.decoder,t=>{try{let{timestamp:r,nick:n,text:s}=b.decode(t.payload),i="no proof";if(t.rateLimitProof){console.log("Proof received: ",t.rateLimitProof);try{console.time("Proof verification took:");let r=t.verify(e.rlnContract.roots());console.timeEnd("Proof verification took:"),i=r?"verified":"not verified"}catch(e){i="invalid",console.error("Failed to verify proof: ",e)}}this.emitMessageEvent({nick:n,text:s,proofStatus:i,time:new Date(r).toDateString()})}catch(e){console.error("Failed in subscription listener: ",e)}})}addEventListener(e,t){return this.emitter.addEventListener(e,t)}removeEventListener(e,t){return this.emitter.removeEventListener(e,t)}emitStatusEvent(e){this.emitter.dispatchEvent(new CustomEvent("status",{detail:e}))}emitMessageEvent(e){this.emitter.dispatchEvent(new CustomEvent("message",{detail:e}))}constructor(){this.contentTopic="/toy-chat/2/luzhou/proto",this.emitter=new EventTarget,this.initialized=!1,this.initializing=!1}},useWaku=()=>{let e=x.useRef(),[t,r]=x.useState([]),{rln:n}=useRLN(),{activeMembershipID:s,credentials:i,setWakuStatus:a}=y();x.useEffect(()=>{if(!i||!s||!n)return;let statusListener=e=>{a(e.detail||"")};E.addEventListener(d.Status,statusListener);let messagesListener=e=>{r(t=>[...t,e.detail])};E.addEventListener(d.Message,messagesListener);let t=!1,run=async()=>{if(t)return;let r={rln:n,credentials:i,membershipID:s};e.current?e.current.initEncoder(r):(await E.init(r),e.current=E)};return run(),()=>{t=!0,E.removeEventListener(d.Status,statusListener),E.removeEventListener(d.Message,messagesListener)}},[s,i,n,a]);let o=x.useCallback(async(t,r)=>{e.current&&await e.current.sendMessage(t,r)},[e]);return{onSend:o,messages:t}},Header=()=>{let{appStatus:e}=y();return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(Block,{className:"mb-5",type:o.FlexHorizontal,children:(0,h.jsx)(Title,{children:"Waku RLN"})}),(0,h.jsx)(Status,{text:"Application status",mark:e})]})},Subtitle=e=>(0,h.jsx)("h2",{className:"text-2xl ".concat(e.className||""),children:e.children}),Button=e=>(0,h.jsx)("button",{onClick:e.onClick,className:"".concat(e.className||""," py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700"),children:e.children}),Waku_Waku=()=>{let{wakuStatus:e}=y(),{onSend:t,messages:r}=useWaku(),{nick:n,text:s,onNickChange:i,onMessageChange:a,resetText:o}=function(){let[e,t]=x.useState(""),[r,n]=x.useState("");return{nick:e,text:r,resetText:()=>{n("")},onNickChange:e=>{t(e.currentTarget.value||"")},onMessageChange:e=>{n(e.currentTarget.value||"")}}}(),onSendClick=async()=>{await t(n,s),o()},l=x.useMemo(()=>r.map(renderMessage),[r]);return(0,h.jsxs)(Block,{className:"mt-10",children:[(0,h.jsxs)(Subtitle,{children:["Waku",(0,h.jsx)("p",{className:"text-xs",children:"(select credentials to initialize)"})]}),(0,h.jsx)(Status,{text:"Waku status",mark:e}),(0,h.jsxs)(Block,{className:"mt-4",children:[(0,h.jsx)("label",{htmlFor:"nick-input",className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Your nickname"}),(0,h.jsx)("input",{type:"text",id:"nick-input",placeholder:"Choose a nickname",value:n,onChange:i,className:"w-full mr-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"})]}),(0,h.jsxs)(Block,{className:"mt-4",children:[(0,h.jsxs)(Block,{className:"mb-2",children:[(0,h.jsx)("label",{htmlFor:"message-input",className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Message"}),(0,h.jsx)("input",{type:"text",id:"message-input",value:s,onChange:a,placeholder:"Text your message here",className:"w-full mr-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"})]}),(0,h.jsx)(Button,{onClick:onSendClick,children:"Send"})]}),(0,h.jsxs)(Block,{className:"mt-8",children:[(0,h.jsx)("p",{className:"text-l mb-4",children:"Messages"}),(0,h.jsx)("div",{children:(0,h.jsx)("ul",{children:l})})]})]})};function renderMessage(e){return(0,h.jsxs)("li",{className:"mb-4",children:[(0,h.jsxs)("p",{children:[(0,h.jsx)("span",{className:"text-lg",children:e.nick}),(0,h.jsxs)("span",{className:"text-sm font-bold",children:["(",e.proofStatus,", ",e.time,")"]}),":"]}),(0,h.jsx)("p",{children:e.text})]},"".concat(e.nick,"-").concat(e.time))}let useKeystore=()=>{let{rln:e}=useRLN(),{credentials:t,setActiveCredential:r,setActiveMembershipID:n,setAppStatus:s,setCredentials:i}=y(),a=x.useCallback(async i=>{if(t&&(null==e?void 0:e.rlnContract)&&i)try{s(l.CREDENTIALS_REGISTERING);let a=await e.rlnContract.registerWithKey(t),o=a.index.toNumber(),c=await e.keystore.addCredential({membership:{treeIndex:o,chainId:f.d$.chainId,address:f.d$.address},identity:t},i);r(c),n(o),e.saveKeystore(),s(l.CREDENTIALS_REGISTERED)}catch(e){s(l.CREDENTIALS_FAILURE),console.error("Failed to register to RLN Contract: ",e);return}},[t,e,r,n,s]),o=x.useCallback(async(t,s)=>{if(e&&t&&s)try{let a=await e.keystore.readCredential(t,s);a&&(i(a.identity),r(t),n(a.membership.treeIndex))}catch(e){console.error("Failed to read credentials from Keystore.");return}},[e,r,n,i]);return{onRegisterCredentials:a,onReadCredentials:o}},Keystore=()=>{let{keystoreCredentials:e}=y(),{onGenerateCredentials:t}=useWallet(),{onReadCredentials:r,onRegisterCredentials:n}=useKeystore(),{password:s,onPasswordChanged:i}=function(){let[e,t]=x.useState("");return{password:e,onPasswordChanged:e=>{t(e.currentTarget.value)}}}(),{selectedKeystore:a,onKeystoreChanged:l}=function(){let[e,t]=x.useState("");return{selectedKeystore:e,onKeystoreChanged:e=>{t(e.currentTarget.value||"")}}}(),{onExportKeystore:c,onImportKeystoreFileChange:d}=function(){let{rln:e}=useRLN(),onImportKeystoreFileChange=async t=>{var r,n;let s=null===(n=t.currentTarget)||void 0===n?void 0:null===(r=n.files)||void 0===r?void 0:r[0];if(!s||!e)return;let i=await s.text();e.importKeystore(i)};return{onExportKeystore:()=>{if(!e)return;let t="keystore.json",r=e.keystore.toString(),n=new File([r],t,{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=t,s.click()},onImportKeystoreFileChange}}(),u=x.useMemo(()=>e.map(e=>(0,h.jsx)("option",{value:e,children:e},e)),[e]);return(0,h.jsxs)(Block,{className:"mt-10",children:[(0,h.jsxs)(Block,{type:o.FlexHorizontal,children:[(0,h.jsx)(Subtitle,{children:"Keystore"}),(0,h.jsxs)("div",{children:[(0,h.jsx)(Button,{children:(0,h.jsx)("label",{htmlFor:"keystore-import",className:"cursor-pointer",children:"Import"})}),(0,h.jsx)("input",{id:"keystore-import",type:"file",className:"hidden",onChange:d}),(0,h.jsx)(Button,{className:"ml-2",onClick:c,children:"Export"})]})]}),(0,h.jsxs)(Block,{className:"mt-4",children:[(0,h.jsx)("label",{htmlFor:"keystore-input",className:"block mb-2 text-sm font-medium text-gray-900 dark:text-white",children:"Password(used for reading/saving into Keystore)"}),(0,h.jsx)("input",{type:"text",value:s,id:"keystore-input",onChange:i,className:"bg-gray-50 border border-gray-300 text-gray-900 text-sm w-full rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"})]}),(0,h.jsxs)(Block,{className:"mt-4",children:[(0,h.jsx)("p",{className:"text-s mb-2",children:"Generate new credentials from wallet"}),(0,h.jsx)(Button,{onClick:t,children:"Generate new credentials"}),(0,h.jsx)(Button,{className:"ml-5",onClick:()=>n(s),children:"Register credentials"})]}),(0,h.jsxs)(Block,{className:"mt-4",children:[(0,h.jsx)("p",{className:"text-s",children:"Read from Keystore"}),(0,h.jsxs)(Block,{type:o.FlexHorizontal,children:[(0,h.jsx)("select",{value:a,onChange:l,className:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-3/4 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500",children:u}),(0,h.jsx)(Button,{onClick:()=>r(a,s),children:"Read credentials"})]})]})]})},BlockchainInfo=()=>{let{ethAccount:e,lastMembershipID:t}=y(),{onFetchContract:r}=useContract();return(0,h.jsxs)(Block,{className:"mt-10",children:[(0,h.jsxs)(Block,{className:"mb-3",type:o.FlexHorizontal,children:[(0,h.jsx)(Subtitle,{children:"Contract"}),(0,h.jsx)(Button,{onClick:r,children:"Fetch state"})]}),(0,h.jsxs)(Block,{type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Your address"}),(0,h.jsx)("code",{children:e||"Not loaded yet"})]}),(0,h.jsxs)(Block,{type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Latest membership ID on contract"}),(0,h.jsx)("code",{children:t||"Not loaded yet"})]})]})};var j=r(9710);let KeystoreDetails=()=>{let{credentials:e,activeCredential:t,activeMembershipID:r}=y();return(0,h.jsxs)(Block,{className:"mt-5",children:[(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Keystore hash"}),(0,h.jsx)("code",{children:t||"none"})]}),(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Membership ID"}),(0,h.jsx)("code",{children:r||"none"})]}),(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Secret Hash"}),(0,h.jsx)("code",{children:renderBytes(null==e?void 0:e.IDSecretHash)})]}),(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Commitment"}),(0,h.jsx)("code",{children:renderBytes(null==e?void 0:e.IDCommitment)})]}),(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Nullifier"}),(0,h.jsx)("code",{children:renderBytes(null==e?void 0:e.IDNullifier)})]}),(0,h.jsxs)(Block,{className:"mt-3",type:o.FlexHorizontal,children:[(0,h.jsx)("p",{children:"Trapdoor"}),(0,h.jsx)("code",{children:renderBytes(null==e?void 0:e.IDTrapdoor)})]})]})};function renderBytes(e){return e?(0,j.ci)(e):"none"}function Home(){return(0,h.jsxs)("main",{className:"flex min-h-screen flex-col p-24 font-mono max-w-screen-lg m-auto",children:[(0,h.jsx)(Header,{}),(0,h.jsx)(BlockchainInfo,{}),(0,h.jsx)(Keystore,{}),(0,h.jsx)(KeystoreDetails,{}),(0,h.jsx)(Waku_Waku,{})]})}}}]);